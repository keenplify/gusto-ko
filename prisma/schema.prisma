// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 1. User Table (Adapted for Wishlist Owner)
model User {
  // Use String for ID to match common UUID/CUID usage in modern applications,
  // especially if integrating external services like Supabase/Firebase Auth.
  id            String    @id @default(cuid()) // Changed to String/cuid() for better compatibility
  name          String? // The name shown on the shared list (e.g., "Ate Sarah's")
  email         String    @unique
  emailVerified DateTime?
  image         String?
  gcashQRUrl    String?
  birthdate     DateTime?

  accounts     Account[]
  sessions     Session[]
  reservations Reservation[]
  wishlists    Wishlist[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Existing Account Table (Kept for Authentication)
model Account {
  userId            String // Changed to String to match the new User.id type
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@id([provider, providerAccountId])
}

// 2. WishlistItem Table (Handles the Gifts)
model Wishlist {
  id String @id @default(cuid())

  // Link to the User (Owner)
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // List Properties
  name      String // e.g., "Christmas 2025" or "30th Birthday"
  shareId   String  @unique // The unique slug for the public link /list/[shareId]
  is_public Boolean @default(true)

  // Link to all the items in this list
  items WishlistItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// 3. WishlistItem Table (Updated to link to Wishlist)
model WishlistItem {
  id String @id @default(cuid())

  // CHANGED: Link to the specific Wishlist container
  wishlistId String
  wishlist   Wishlist @relation(fields: [wishlistId], references: [id], onDelete: Cascade)

  // Item Details (Captured by Magic Link)
  name          String
  image_url     String?
  original_link String?
  price         Int?
  notes         String?

  // Status and Reservation
  reservation_status String        @default("UNRESERVED")
  reservations       Reservation[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// 3. Reservations Table (The Anonymity Engine)
model Reservation {
  id String @id @default(cuid())

  itemId String?
  item   WishlistItem? @relation(fields: [itemId], references: [id], onDelete: Cascade)

  giver_session_id String // A unique, temporary ID (e.g., hash or CUID) for the Giver (Guest)
  giver_nickname   String? // Optional nickname for display to *other Givers*
  giver_email      String? // Optional email for Giver follow-up (kept private from List Owner)
  giver_message    String? // (For MySQL use: String? @db.Text)
  giver_amount     Int?

  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Tracking
  is_purchased Boolean  @default(false)
  reserved_at  DateTime @default(now())

  // An item can be reserved multiple times, but we will manage that in the application logic
  // (e.g., only show the 'Reserved by X people' count).
}

model Session {
  id           Int      @id @default(autoincrement())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
